pipeline {
    agent any

    stages {
        stage('Checkout Code') {
            steps {
                echo 'ğŸ”„ Mengambil source code dari GitHub...'
                git 'https://github.com/akanabot/cloudcomptw.git'
            }
        }

        stage('Build Docker Images') {
            steps {
                echo 'ğŸ—ï¸ Membangun Docker image Laravel...'
                bat 'docker-compose -f docker-compose.yml build'
            }
        }

        stage('Start Laravel Container') {
            steps {
                echo 'ğŸš€ Menjalankan container Laravel...'
                bat 'docker-compose -f docker-compose.yml up -d'
            }
        }

        stage('Verify Laravel Running') {
            steps {
                echo 'ğŸ” Mengecek apakah Laravel sudah aktif...'
                // Tunggu 15 detik biar Laravel siap
                bat 'timeout /t 15'
                
                // Coba akses container Laravel
                bat 'docker exec cloudcomptw-app curl -f http://localhost:8000 || exit 1'
            }
        }
    }

    post {
        always {
            echo 'ğŸ§¹ Membersihkan container...'
            bat 'docker-compose -f docker-compose.yml down'
        }
    }
}
